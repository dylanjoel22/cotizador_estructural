{% extends 'base.html' %}
{% block page_title %}Nueva Cotización Interna {% endblock %}
{% block content %}



<div class="max-w-7xl mx-auto p-6 bg-white rounded-xl shadow-lg border border-gray-200">
    <h1 class="text-3xl font-extrabold text-[#002B5B] mb-6 border-b-4 border-[#7CA8D5] pb-3">
        Registro de Materiales y Costos Reales
    </h1>
    
    {% if error_message %}
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-4 rounded-lg" role="alert">
            <p class="font-bold">Error de Proceso:</p>
            <p>{{ error_message }}</p>
        </div>
    {% endif %}

    <form method="POST" id="cotizacionForm">
        {% csrf_token %}
        
        <div class="mb-8 p-5 border border-gray-200 rounded-lg bg-blue-50/50">
            <label for="cliente_nombre" class="block text-sm font-bold text-[#002B5B] mb-1">Cliente/Proyecto:</label>
            <input type="text" name="cliente_nombre" id="cliente_nombre" required
                   class="w-full border-gray-300 rounded-lg shadow-sm focus:border-[#7CA8D5] focus:ring-[#7CA8D5] p-2 transition-all"
                   placeholder="E.g., Proyecto Galpón Sur">
        </div>
        
        <h2 class="text-xl font-bold text-[#002B5B] mb-4 flex items-center">
            <i class="fas fa-boxes mr-2 text-[#7CA8D5]"></i> Detalle de Materiales
        </h2>
        
        <div class="overflow-x-auto shadow-xl rounded-lg border border-gray-100">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-[#002B5B] text-white">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-semibold uppercase tracking-wider min-w-[200px]">Material</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-16">Largo (mm)</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-16">Largo (m)</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-20">Unidad Com. (m)</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-16">Cant. Nec.</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-16">Cant. Comp.</th>
                        <th class="px-2 py-3 text-right text-xs font-semibold uppercase tracking-wider w-24">Valor Und. ($)</th>
                        <th class="px-2 py-3 text-right text-xs font-semibold uppercase tracking-wider w-32">Valor Total ($)</th>
                        <th class="px-2 py-3 text-center text-xs font-semibold uppercase tracking-wider w-20">Peso (kg/m)</th>
                        <th class="px-2 py-3 text-right text-xs font-semibold uppercase tracking-wider w-32">Peso Total (kg)</th>
                        <th class="px-2 py-3 text-center w-10"></th>
                    </tr>
                </thead>
                <tbody id="itemsTableBody" class="bg-white divide-y divide-gray-100">
                    </tbody>
                <tfoot class="bg-gray-100 border-t border-gray-300">
                    <tr>
                        <td colspan="7" class="px-3 py-3 text-right text-base font-bold text-gray-700">TOTALES:</td>
                        <td class="px-2 py-3 text-right text-base font-extrabold text-[#002B5B]">
                            <span id="grandTotalValue">$ 0.00</span>
                        </td>
                        <td colspan="1" class="px-2 py-3 text-right text-base font-bold text-gray-700">PESO:</td>
                        <td class="px-2 py-3 text-right text-base font-extrabold text-[#002B5B]">
                            <span id="grandTotalWeight">0.000 kg</span>
                        </td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>
        </div>
        
        <button type="button" id="addItemButton"
                class="mt-4 px-4 py-2 border border-transparent text-sm font-medium rounded-lg shadow-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150">
            <i class="fas fa-plus mr-1"></i> Agregar Material
        </button>

        <input type="hidden" name="items_json" id="itemsJsonInput">

        <hr class="my-8 border-gray-200">

        <div class="mb-6">
            <label for="notas_internas" class="block text-sm font-bold text-[#002B5B] mb-1">Notas Internas (Para su registro)</label>
            <textarea name="notas_internas" id="notas_internas" rows="4"
                      class="w-full border-gray-300 rounded-lg shadow-sm focus:border-[#7CA8D5] focus:ring-[#7CA8D5] p-2 transition-all"
                      placeholder="Ej: Costo unitario basado en proveedor X. Considerar 10% de merma en cortes."></textarea>
        </div>

        <div class="flex justify-end">
            <button type="submit"
                    class="px-8 py-3 text-base font-semibold rounded-lg shadow-xl text-white bg-[#002B5B] hover:bg-[#001E3C] focus:outline-none focus:ring-4 focus:ring-[#7CA8D5] focus:ring-offset-2 focus:ring-offset-white transition duration-200">
                <i class="fas fa-save mr-2"></i> Guardar Cotización Cruda
            </button>
        </div>
    </form>
</div>

<script>
    const itemsTableBody = document.getElementById('itemsTableBody');
    const addItemButton = document.getElementById('addItemButton');
    const grandTotalValueSpan = document.getElementById('grandTotalValue');
    const grandTotalWeightSpan = document.getElementById('grandTotalWeight');
    const itemsJsonInput = document.getElementById('itemsJsonInput');
    const form = document.getElementById('cotizacionForm');
    
    let currentItems = []; 

    function renderItems() {
        itemsTableBody.innerHTML = '';
        let grandTotalValue = 0;
        let grandTotalWeight = 0;

        currentItems.forEach((item, index) => {
            const valorTotal = item.cant_a_comprar * item.valor_unitario;
            const pesoTotalKg = item.cant_a_comprar * item.unidad_comercial * item.peso_kg_m;
            
            grandTotalValue += valorTotal;
            grandTotalWeight += pesoTotalKg;

            const row = itemsTableBody.insertRow();
            row.className = 'hover:bg-blue-50/50 transition duration-100';
            
            // Clase base para inputs (estilo para que parezca texto y no input normal)
            const inputClass = "w-full border-none focus:ring-1 focus:ring-indigo-300 p-0 bg-transparent text-sm rounded-sm";
            
            row.innerHTML = `
                <td class="px-3 py-2 text-sm text-gray-900"><input type="text" data-index="${index}" data-field="material_nombre" value="${item.material_nombre}" class="${inputClass}"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="largo_mm" value="${item.largo_mm}" min="0" class="${inputClass} text-center"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="largo_m" value="${item.largo_m}" min="0" step="0.01" class="${inputClass} text-center"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="unidad_comercial" value="${item.unidad_comercial}" min="0" step="0.01" class="${inputClass} text-center"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="cant_necesaria" value="${item.cant_necesaria}" min="1" class="${inputClass} text-center"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="cant_a_comprar" value="${item.cant_a_comprar}" min="1" class="${inputClass} text-center font-bold"></td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="valor_unitario" value="${item.valor_unitario}" min="0" step="0.01" class="${inputClass} text-right font-semibold text-red-600"></td>
                <td class="px-2 py-2 text-sm font-bold text-gray-800 text-right">$ ${valorTotal.toLocaleString('es-CL', { minimumFractionDigits: 2 })}</td>
                <td class="px-2 py-2 text-sm text-gray-900"><input type="number" data-index="${index}" data-field="peso_kg_m" value="${item.peso_kg_m}" min="0" step="0.01" class="${inputClass} text-center"></td>
                <td class="px-2 py-2 text-sm font-semibold text-gray-800 text-right">${pesoTotalKg.toFixed(3)} kg</td>
                <td class="px-2 py-2 text-sm font-medium text-center">
                    <button type="button" onclick="removeItem(${index})" 
                            class="text-red-500 hover:text-red-700 transition duration-150 p-1 rounded-full hover:bg-red-50">
                            <i class="fas fa-trash-alt text-xs"></i>
                    </button>
                </td>
            `;
        });

        // Actualizar totales en el footer
        grandTotalValueSpan.textContent = `$ ${grandTotalValue.toLocaleString('es-CL', { minimumFractionDigits: 2 })}`;
        grandTotalWeightSpan.textContent = `${grandTotalWeight.toFixed(3)} kg`;
    }
    
    // Función de actualización
    function updateItem(input) {
        const index = parseInt(input.dataset.index);
        const field = input.dataset.field;
        let value = input.value;
        
        // Conversión y validación de tipos
        if (['largo_mm', 'cant_necesaria', 'cant_a_comprar'].includes(field)) {
            value = parseInt(value) || 0;
            if (field === 'cant_necesaria' && value < 1) value = 1;
            if (field === 'cant_a_comprar' && value < 1) value = 1;

        } else if (['largo_m', 'unidad_comercial', 'valor_unitario', 'peso_kg_m'].includes(field)) {
            value = parseFloat(value) || 0.00;
        }

        currentItems[index][field] = value;
        renderItems();
    }
    
    // Asocia la función de actualización a todos los cambios en la tabla
    itemsTableBody.addEventListener('change', (e) => {
        if (e.target.tagName === 'INPUT') {
            updateItem(e.target);
        }
    });

    // Añade un material de ejemplo
    function addItem() {
        currentItems.push({ 
            material_nombre: 'Perfil Estructural', 
            largo_mm: 6000, 
            largo_m: 6.00, 
            unidad_comercial: 6.00, 
            cant_necesaria: 1, 
            cant_a_comprar: 1, 
            valor_unitario: 10000.00, 
            peso_kg_m: 1.00 
        });
        renderItems();
    }
    
    function removeItem(index) {
        currentItems.splice(index, 1);
        renderItems();
    }

    // Listeners principales
    addItemButton.addEventListener('click', addItem);

    // Antes de enviar, serializa el array a JSON
    form.addEventListener('submit', function(e) {
        if (currentItems.length === 0) {
             e.preventDefault();
             alert("Debe agregar al menos un material a la cotización.");
             return;
        }
        // Asegura que los últimos cambios se reflejen antes de serializar
        itemsJsonInput.value = JSON.stringify(currentItems);
    });
    
    // Inicializar
    addItem(); 
</script>

{% endblock %}