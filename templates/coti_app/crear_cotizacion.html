{% extends 'base.html' %}
{% block page_title %}Nueva Cotización{% endblock %}
{% block page_subtitle %}Configura los materiales y costos del proyecto{% endblock %}

{% block content %}

<style>
    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -1000px 0;
        }

        100% {
            background-position: 1000px 0;
        }
    }

    .animate-slide-up {
        animation: slideInUp 0.5s ease-out;
    }

    .gradient-border {
        position: relative;
        background: linear-gradient(white, white) padding-box,
            linear-gradient(135deg, #002B5B, #4A90E2) border-box;
        border: 2px solid transparent;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
    }

    .hover-lift {
        /* OPTIMIZADO: Solo anima transform (más rápido que 'all') */
        transition: transform 0.15s cubic-bezier(0.4, 0, 0.2, 1),
            box-shadow 0.15s cubic-bezier(0.4, 0, 0.2, 1);
        /* Aceleración GPU para animaciones más suaves */
        will-change: transform;
        transform: translateZ(0);
    }

    .hover-lift:hover {
        transform: translateY(-4px) translateZ(0);
        box-shadow: 0 20px 25px -5px rgba(0, 43, 91, 0.1), 0 10px 10px -5px rgba(0, 43, 91, 0.04);
    }

    /* Optimización global para todas las transiciones */
    * {

        /* Reduce motion para usuarios que prefieren menos animación */
        @media (prefers-reduced-motion: reduce) {
            transition-duration: 0.01ms !important;
            animation-duration: 0.01ms !important;
        }
    }

    /* Optimización específica para botones y cards */
    button,
    .card,
    [class*="hover:"] {
        /* Aceleración GPU */
        transform: translateZ(0);
        /* Suavizado de fuentes durante animación */
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    .skeleton-loader {
        background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
        background-size: 1000px 100%;
        animation: shimmer 2s infinite;
    }

    /* Spinner de carga */
    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .spinner {
        animation: spin 0.6s linear infinite;
    }

    /* Pulse animation para loaders */
    @keyframes pulse {

        0%,
        100% {
            opacity: 1;
        }

        50% {
            opacity: 0.5;
        }
    }

    .pulse {
        animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
</style>

<div class="min-h-screen p-3 sm:p-4 md:p-6 lg:p-8">

    <!-- Header Section -->
    <header class="mb-8 animate-slide-up">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div class="flex items-start space-x-4">
                <div
                    class="w-14 h-14 bg-gradient-to-br from-[#002B5B] to-[#4A90E2] rounded-2xl flex items-center justify-center shadow-lg">
                    <i class="fas fa-file-invoice text-white text-2xl"></i>
                </div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span
                            class="px-3 py-1 bg-[#4A90E2]/10 text-[#002B5B] text-xs font-bold rounded-full border border-[#4A90E2]/20">
                            Nuevo Proyecto
                        </span>
                        <span class="text-xs text-slate-500">
                            <i class="far fa-clock mr-1"></i>
                            Guardado automático
                        </span>
                    </div>
                    <p class="text-slate-600 text-sm">Ejemplo</p>
                </div>
            </div>

            <div class="flex gap-3 w-full md:w-auto">
                <button type="button"
                    class="flex-1 md:flex-none px-6 py-3 bg-white border-2 border-slate-200 text-slate-700 font-semibold rounded-xl hover:bg-slate-50 transition-all shadow-sm">
                    <i class="fas fa-save mr-2"></i>Guardar Borrador
                </button>
                <button type="submit" form="cotizacionForm"
                    class="flex-1 md:flex-none px-6 py-3 bg-gradient-to-r from-[#002B5B] to-[#4A90E2] hover:from-[#001f42] hover:to-[#3b7bc9] text-white font-bold rounded-xl shadow-lg shadow-[#4A90E2]/30 transition-all transform hover:scale-105">
                    <i class="fas fa-check-circle mr-2"></i>Crear Cotización
                </button>
            </div>
        </div>
    </header>

    <form method="POST" id="cotizacionForm">
        {% csrf_token %}

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

            <!-- Left Sidebar - Project Info -->
            <div class="lg:col-span-4 space-y-6">

                <!-- Datos Generales -->
                <div
                    class="glass-card rounded-2xl shadow-lg border border-slate-200/60 p-4 md:p-6 hover-lift animate-slide-up">
                    <div class="flex items-center mb-6">
                        <div
                            class="w-10 h-10 bg-gradient-to-br from-[#4A90E2]/20 to-[#002B5B]/10 rounded-xl flex items-center justify-center mr-3">
                            <i class="fas fa-folder-open text-[#002B5B]"></i>
                        </div>
                        <h3 class="font-bold text-[#002B5B] text-lg">Información del Proyecto</h3>
                    </div>

                    <div class="space-y-2 md:space-y-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wide mb-1.5">
                                <i class="fas fa-pen mr-1 text-[#4A90E2]"></i>Nombre del Proyecto
                            </label>
                            <input type="text" name="proyecto_nombre" id="proyecto_nombre" required
                                class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-800 font-medium focus:ring-2 focus:ring-[#4A90E2] focus:border-[#4A90E2] placeholder-slate-400 transition-all">
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wide mb-1.5">
                                <i class="fas fa-building mr-1 text-[#4A90E2]"></i>Empresa
                            </label>
                            <div class="flex gap-2 items-center">
                                <select name="cliente" id="empresa_select"
                                    class="flex-1 h-9 md:h-10 bg-white border-2 border-slate-200 rounded-xl px-3 md:px-4 text-sm md:text-base text-slate-700 font-medium focus:ring-2 focus:ring-[#4A90E2] transition-all cursor-pointer">
                                    <option value="">Seleccionar empresa...</option>
                                    {% for cliente in clientes_disponibles %}
                                    <option value="{{ cliente.id }}">{{ cliente.nombre }}</option>
                                    {% endfor %}
                                </select>

                                <a href="{% url 'añadir_cliente' %}" target="_blank" id="btnNuevaEmpresa"
                                    class="flex items-center justify-center h-9 w-9 md:h-10 md:w-10 bg-white border-2 border-slate-200 text-[#4A90E2] hover:bg-slate-50 rounded-xl transition-all shrink-0">
                                    <i class="fas fa-plus text-sm"></i>
                                </a>
                            </div>
                        </div>

                        <div>
                            <label class="block text-xs font-bold text-slate-600 uppercase tracking-wide mb-1.5">
                                <i class="fas fa-user-tie mr-1 text-[#4A90E2]"></i>Contacto Asociado
                            </label>
                            <div class="flex gap-2 items-center">
                                <select name="contacto" id="contacto_select" disabled
                                    class="flex-1 h-9 md:h-10 bg-slate-100 border-2 border-slate-200 rounded-xl px-3 md:px-4 text-sm md:text-base text-slate-400 font-medium focus:ring-2 focus:ring-[#4A90E2] transition-all disabled:cursor-not-allowed">
                                    <option value="">Primero seleccione empresa...</option>
                                </select>

                                <button type="button" id="btnNuevoContacto" disabled
                                    class="h-9 w-9 md:h-10 md:w-10 bg-gradient-to-br from-slate-300 to-slate-400 text-white rounded-xl transition-all shadow-none cursor-not-allowed shrink-0">
                                    <i class="fas fa-user-plus text-sm"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cost Summary Card -->
                <div
                    class="rounded-2xl shadow-2xl border border-[#002B5B]/20 p-6 bg-gradient-to-br from-[#002B5B] to-[#003d7a] text-white lg:sticky lg:top-24 hover-lift animate-slide-up relative overflow-hidden">

                    <div
                        class="absolute top-0 right-0 w-32 h-32 bg-white/10 rounded-full mix-blend-overlay filter blur-2xl -mr-10 -mt-10 pointer-events-none">
                    </div>

                    <div class="flex justify-between items-start mb-6 relative z-10">
                        <div>
                            <p class="text-blue-200 text-sm font-semibold uppercase tracking-wide">Inversión Total</p>
                            <h2 class="text-5xl font-black mt-2 tracking-tight" id="grandTotalGeneral">$ 0</h2>
                        </div>
                        <div class="p-4 bg-white/10 rounded-2xl backdrop-blur-sm border border-white/20">
                            <i class="fas fa-calculator text-blue-300 text-2xl"></i>
                        </div>
                    </div>

                    <div class="space-y-4 pt-6 border-t border-white/20 relative z-10">
                        <div class="bg-white/5 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-white/90 text-sm flex items-center">
                                    <i class="fas fa-industry mr-2 text-blue-300"></i>Materiales
                                </span>
                                <span class="font-bold text-lg" id="structuralTotalValue">$ 0</span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-white/60">Peso Acero</span>
                                <span class="font-mono font-semibold text-blue-300" id="structuralTotalWeight">0.00
                                    kg</span>
                            </div>
                        </div>

                        <div class="bg-white/5 rounded-xl p-4 backdrop-blur-sm border border-white/10">
                            <div class="flex justify-between items-center">
                                <span class="text-white/90 text-sm flex items-center">
                                    <i class="fas fa-tools mr-2 text-blue-300"></i>Insumos
                                </span>
                                <span class="font-bold text-lg" id="overheadTotalValue">$ 0</span>
                            </div>
                        </div>
                    </div>

                    <div class="mt-6 pt-6 border-t border-white/20 relative z-10">
                        <label class="text-xs text-white/70 uppercase font-bold mb-2 block">
                            <i class="fas fa-sticky-note mr-1"></i>Notas Internas
                        </label>
                        <textarea name="notas_internas" id="notas_internas" rows="3"
                            class="w-full bg-black/20 border border-white/10 rounded-xl text-sm text-white placeholder-white/40 focus:ring-2 focus:ring-blue-400 p-3 backdrop-blur-sm resize-none"
                            placeholder="Observaciones..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="lg:col-span-8 space-y-6">

                <!-- Material Search Section -->
                <div class="glass-card rounded-2xl shadow-lg border border-slate-200/60 p-8 relative overflow-hidden animate-slide-up hover-lift"
                    style="animation-delay: 0.1s;">
                    <!-- Decorative gradient blob -->
                    <div
                        class="absolute top-0 right-0 w-96 h-96 bg-gradient-to-br from-[#4A90E2]/20 to-transparent rounded-full mix-blend-multiply filter blur-3xl opacity-70 -mr-32 -mt-32 pointer-events-none">
                    </div>

                    <div class="relative z-10">
                        <div class="flex items-center mb-6">
                            <div
                                class="w-12 h-12 bg-gradient-to-br from-[#4A90E2] to-[#002B5B] rounded-xl flex items-center justify-center mr-4 shadow-lg">
                                <i class="fas fa-search text-white text-xl"></i>
                            </div>
                            <div>
                                <h3 class="text-xl font-bold text-[#002B5B]">Búsqueda de Perfiles</h3>
                                <p class="text-sm text-slate-500">Encuentra el material estructural perfecto</p>
                            </div>
                        </div>

                        <!-- Search Input -->
                        <div class="relative mb-8">
                            <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                                <i class="fas fa-bolt text-yellow-500 text-xl animate-pulse"></i>
                            </div>
                            <input type="text" id="profile-search"
                                class="w-full bg-slate-50 border-2 border-slate-200 text-slate-800 text-lg rounded-2xl px-6 py-5 pl-16 focus:ring-2 focus:ring-[#4A90E2] focus:border-[#4A90E2] placeholder-slate-400 transition-all font-medium"
                                placeholder="Buscar perfil rápido (ej: H 200, IPE 300, C 150)...">

                            <div id="autocomplete-results"
                                class="absolute w-full mt-3 bg-white rounded-2xl shadow-2xl z-50 overflow-hidden border-2 border-slate-200 hidden max-h-96 overflow-y-auto">
                            </div>
                        </div>

                        <!-- Filter Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="group">
                                <label
                                    class="text-xs font-bold text-slate-500 uppercase mb-2 block h-8 flex items-end">Tipo</label>
                                <div class="relative">
                                    <select id="category-select"
                                        class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-700 font-medium focus:ring-2 focus:ring-[#4A90E2] cursor-pointer appearance-none transition-all">
                                        <option value="">Seleccionar...</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="group">
                                <label
                                    class="text-xs font-bold text-slate-500 uppercase mb-2 block h-8 flex items-end">Altura</label>
                                <div class="relative">
                                    <select id="height-select" disabled
                                        class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-400 font-medium appearance-none transition-all disabled:cursor-not-allowed">
                                        <option>Primero tipo...</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="group">
                                <label
                                    class="text-xs font-bold text-slate-500 uppercase mb-2 block h-8 flex items-end">Ancho</label>
                                <div class="relative">
                                    <select id="width-select" disabled
                                        class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-400 font-medium appearance-none transition-all disabled:cursor-not-allowed">
                                        <option>Primero altura...</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>

                            <div class="group">
                                <label
                                    class="text-xs font-bold text-slate-500 uppercase mb-2 block h-8 flex items-end">Espesores</label>
                                <div class="relative">
                                    <select id="thickness-select" disabled
                                        class="w-full bg-slate-100 border-2 border-slate-200 rounded-xl px-4 py-3 text-slate-400 font-medium appearance-none transition-all disabled:cursor-not-allowed">
                                        <option>Primero ancho...</option>
                                    </select>
                                    <i
                                        class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                                </div>
                            </div>
                        </div>

                        <!-- Guided Selection Button -->
                        <div id="guided-add-button-container" class="mt-6 hidden">
                            <button type="button" id="add-from-guided-btn"
                                class="w-full py-4 bg-gradient-to-r from-[#4A90E2] to-[#002B5B] hover:from-[#3b7bc9] hover:to-[#001f42] text-white rounded-2xl font-bold transition-all flex justify-center items-center gap-3 shadow-lg shadow-[#4A90E2]/30 transform hover:scale-[1.02]">
                                <i class="fas fa-check-circle text-xl"></i>
                                <span>Agregar:</span>
                                <span id="guided-profile-name"
                                    class="font-mono bg-white/20 px-3 py-1 rounded-lg"></span>
                                <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Structural Items Table -->
                <div class="glass-card rounded-2xl shadow-lg border border-slate-200/60 overflow-hidden hover-lift animate-slide-up"
                    style="animation-delay: 0.2s;">
                    <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-[#4A90E2]/20 to-[#002B5B]/10 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-cubes text-[#002B5B]"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-[#002B5B] text-lg">Materiales Estructurales</h4>
                                    <p class="text-xs text-slate-500">Lista de perfiles agrupados por sección</p>
                                </div>
                            </div>
                            <div class="flex items-center gap-2">
                                <!-- Badge de Sección Actual -->
                                <div
                                    class="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-300 rounded-lg">
                                    <i class="fas fa-map-marker-alt text-emerald-600"></i>
                                    <span class="text-sm font-bold text-slate-700">Sección actual:</span>
                                    <select id="currentSectionSelector"
                                        class="text-sm font-bold text-emerald-700 bg-transparent border-none focus:ring-0 cursor-pointer pr-6">
                                        <option value="general">General</option>
                                    </select>
                                </div>

                                <button type="button" id="btnNuevaSeccion"
                                    class="px-4 py-2 bg-gradient-to-r from-[#4A90E2] to-[#002B5B] hover:from-[#3b7bc9] hover:to-[#001f42] text-white rounded-lg font-bold transition-all flex items-center gap-2 shadow-md transform hover:scale-105">
                                    <i class="fas fa-plus-circle"></i>
                                    Nueva Sección
                                </button>
                                <span
                                    class="px-3 py-1 bg-[#4A90E2]/10 text-[#002B5B] text-xs font-bold rounded-lg border border-[#4A90E2]/20">
                                    <i class="fas fa-layer-group mr-1"></i>Items: <span id="structural-count">0</span>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead>
                                <thead>
                                    <tr
                                        class="text-xs text-slate-600 font-bold uppercase tracking-wider border-b-2 border-slate-200 bg-slate-50">
                                        <th class="px-3 py-4 text-left sticky left-0 bg-slate-50 z-10">Material</th>
                                        <th class="px-3 py-4 text-center">Largo (M)</th>
                                        <th class="px-3 py-4 text-center">U. Comercial</th>
                                        <th class="px-3 py-4 text-center">C. Necesaria</th>
                                        <th class="px-3 py-4 text-center">A Comprar</th>
                                        <th class="px-3 py-4 text-right">Peso (Kg/m)</th>
                                        <th class="px-3 py-4 text-right">Peso Total</th>
                                        <th class="px-3 py-4 text-right">Valor Unit.</th>
                                        <th class="px-3 py-4 text-right">Valor Total</th>
                                        <th class="px-3 py-4 text-center sticky right-0 bg-slate-50 z-10"></th>
                                    </tr>
                                </thead>
                            </thead>
                            <tbody id="structuralItemsTableBody" class="text-sm divide-y divide-slate-100">
                                <tr id="empty-state-row">
                                    <td colspan="7" class="px-6 py-16 text-center bg-slate-50/50">
                                        <div class="flex flex-col items-center">
                                            <div
                                                class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                                <i class="fas fa-cubes text-4xl text-slate-300"></i>
                                            </div>
                                            <p class="text-slate-400 font-medium">No hay materiales agregados</p>
                                            <p class="text-slate-400 text-xs mt-1">Utilice el buscador arriba para
                                                agregar perfiles</p>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Overhead Items Table -->
                <div class="glass-card rounded-2xl shadow-lg border border-slate-200/60 overflow-hidden hover-lift animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <div class="p-6 border-b border-slate-200 bg-gradient-to-r from-slate-50 to-white">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center">
                                <div
                                    class="w-10 h-10 bg-gradient-to-br from-[#4A90E2]/20 to-[#002B5B]/10 rounded-lg flex items-center justify-center mr-3">
                                    <i class="fas fa-tools text-[#002B5B]"></i>
                                </div>
                                <div>
                                    <h4 class="font-bold text-[#002B5B] text-lg">Costos Adicionales e Insumos</h4>
                                    <p class="text-xs text-slate-500">Mano de obra, transporte, pintura, soldadura, etc.
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Guía rápida -->
                        <div class="bg-blue-50 border-l-4 border-[#4A90E2] p-3 rounded-r-lg">
                            <div class="flex items-start">
                                <i class="fas fa-lightbulb text-[#4A90E2] mt-0.5 mr-2"></i>
                                <div class="text-xs text-slate-600">
                                    <span class="font-semibold text-[#002B5B]">Tip:</span>
                                    Agrega servicios como <span class="font-medium">Mano de obra</span>,
                                    <span class="font-medium">Transporte</span>,
                                    <span class="font-medium">Pintura anticorrosiva</span>,
                                    o cualquier costo adicional del proyecto.
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="p-6">
                        <table class="w-full">
                            <tbody id="overheadItemsTableBody" class="divide-y divide-slate-100"></tbody>
                            <tfoot>
                                <!-- Etiquetas de columnas -->
                                <tr class="text-xs text-slate-500 uppercase font-semibold tracking-wide">
                                    <td class="px-3 pb-2 pt-4">
                                        <i class="fas fa-file-alt mr-1 text-[#4A90E2]"></i>Descripción
                                    </td>
                                    <td class="px-3 pb-2 pt-4 text-center">
                                        <i class="fas fa-tag mr-1 text-[#4A90E2]"></i>Unidad
                                    </td>
                                    <td class="px-3 pb-2 pt-4 text-center">
                                        <i class="fas fa-hashtag mr-1 text-[#4A90E2]"></i>Cantidad
                                    </td>
                                    <td class="px-3 pb-2 pt-4 text-right">
                                        <i class="fas fa-dollar-sign mr-1 text-[#4A90E2]"></i>Valor Unitario
                                    </td>
                                    <td class="px-3 pb-2 pt-4"></td>
                                </tr>

                                <!-- Inputs de ingreso -->
                                <tr class="bg-slate-50 rounded-xl">
                                    <td class="p-3">
                                        <input type="text" id="overheadDesc"
                                            placeholder="Ej: Mano de obra instalación, Transporte..."
                                            class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-[#4A90E2] focus:border-[#4A90E2] font-medium transition-all placeholder-slate-400">
                                    </td>
                                    <td class="p-3 w-32">
                                        <input type="text" id="overheadUnidad" placeholder="Ej: HH, Viaje"
                                            class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-3 text-sm text-center transition-all placeholder-slate-400 focus:ring-2 focus:ring-[#4A90E2]">
                                    </td>
                                    <td class="p-3 w-28">
                                        <input type="number" id="overheadCantidad" value="1" min="1"
                                            class="w-full bg-white border-2 border-slate-200 rounded-xl px-4 py-3 text-sm text-center font-semibold transition-all focus:ring-2 focus:ring-[#4A90E2]">
                                    </td>
                                    <td class="p-3 w-36">
                                        <div class="relative">
                                            <span
                                                class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm">$</span>
                                            <input type="number" id="overheadValor" value="0" min="0" step="1000"
                                                class="w-full bg-white border-2 border-slate-200 rounded-xl pl-7 pr-4 py-3 text-sm text-right font-semibold transition-all focus:ring-2 focus:ring-[#4A90E2]">
                                        </div>
                                    </td>
                                    <td class="p-3 w-16">
                                        <button type="button" id="addOverheadItemButton"
                                            class="w-12 h-12 flex items-center justify-center bg-gradient-to-br from-[#4A90E2] to-[#002B5B] hover:from-[#3b7bc9] hover:to-[#001f42] text-white rounded-xl shadow-lg transition-all transform hover:scale-110"
                                            title="Agregar insumo">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>

            </div>
        </div>

        <input type="hidden" name="structural_items_json" id="structuralItemsJsonInput">
        <input type="hidden" name="overhead_items_json" id="overheadItemsJsonInput">
        <input type="hidden" name="total_costo" id="totalCostoInput">
    </form>
</div>

<!-- Structural Item Modal -->
<div id="structuralItemModal"
    class="fixed inset-0 z-50 bg-slate-900/80 backdrop-blur-md flex items-center justify-center p-4 transition-opacity duration-300"
    style="display: none;">
    <div
        class="bg-white rounded-3xl shadow-2xl w-full max-w-3xl mx-3 sm:mx-auto transform transition-all duration-300 scale-95 overflow-hidden border-2 border-slate-200">
        <div class="bg-gradient-to-r from-[#002B5B] to-[#4A90E2] p-6 text-white">
            <div class="flex justify-between items-start">
                <div>
                    <h3 class="text-2xl font-bold mb-1">Configurar Material</h3>
                    <p id="modalProfileName"
                        class="text-white/80 text-lg font-mono mt-2 bg-white/10 px-3 py-1 rounded-lg inline-block"></p>
                </div>
                <button type="button" id="closeStructuralModal"
                    class="w-10 h-10 bg-white/10 hover:bg-white/20 rounded-xl transition-colors flex items-center justify-center">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <div class="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Specifications Card -->
            <div class="bg-gradient-to-br from-slate-50 to-slate-100 p-6 rounded-2xl border-2 border-slate-200">
                <h4 class="font-bold text-slate-600 uppercase text-xs mb-4 flex items-center">
                    <i class="fas fa-info-circle mr-2 text-[#4A90E2]"></i>Especificaciones Técnicas
                </h4>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                        <span class="text-slate-600 font-medium">Peso Lineal:</span>
                        <span id="modalProfileWeight" class="font-mono font-bold text-[#002B5B]"></span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                        <span class="text-slate-600 font-medium">Altura (d):</span>
                        <span id="modalProfileHeight" class="font-mono font-bold text-[#002B5B]"></span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                        <span class="text-slate-600 font-medium">Ancho (bf):</span>
                        <span id="modalProfileWidth" class="font-mono font-bold text-[#002B5B]"></span>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-white rounded-lg">
                        <span class="text-slate-600 font-medium">Espesores:</span>
                        <span class="font-mono font-bold text-[#002B5B]">
                            <span id="modalProfileDimTf"></span> / <span id="modalProfileDimTw"></span> mm
                        </span>
                    </div>
                    <div
                        class="flex justify-between items-center p-2 bg-gradient-to-r from-[#4A90E2]/10 to-[#002B5B]/5 rounded-lg border border-[#4A90E2]/20 mt-3">
                        <span class="text-[#002B5B] font-bold">Área Total:</span>
                        <span id="modalProfileArea" class="font-mono font-bold text-[#002B5B]"></span>
                    </div>
                </div>
            </div>

            <!-- Input Fields -->
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-600 uppercase mb-2 flex items-center">
                        <i class="fas fa-ruler mr-2 text-[#4A90E2]"></i>Largo del Perfil (metros)
                    </label>
                    <input type="number" id="modalLargoM" value="6.0" step="0.01"
                        class="w-full border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-[#4A90E2] focus:border-[#4A90E2] p-4 bg-white text-xl font-bold text-[#002B5B] transition-all">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-600 uppercase mb-2 flex items-center">
                            <i class="fas fa-sort-numeric-up mr-2 text-[#4A90E2]"></i>Cantidad
                        </label>
                        <input type="number" id="modalCantComprar" value="1" min="1"
                            class="w-full border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-[#4A90E2] p-3 bg-white font-bold text-lg text-[#002B5B] transition-all">
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-red-600 uppercase mb-2 flex items-center">
                            <i class="fas fa-dollar-sign mr-2"></i>Precio Unitario
                        </label>
                        <input type="number" id="modalValorUnitario" value="0" step="0.01"
                            class="w-full border-2 border-red-200 text-red-700 rounded-xl focus:ring-2 focus:ring-red-500 p-3 bg-red-50 font-bold text-lg transition-all">
                    </div>
                </div>

                <input type="hidden" id="modalProfileId">
                <input type="hidden" id="modalProfilePesoKgM">
                <input type="hidden" id="modalProfileNombre">

                <!-- Cost Preview -->
                <div class="bg-gradient-to-br from-[#002B5B] to-[#4A90E2] text-white p-4 rounded-xl">
                    <div class="text-xs uppercase font-bold mb-1 opacity-80">Subtotal Estimado</div>
                    <div class="text-3xl font-black" id="modalSubtotalPreview">$ 0</div>
                </div>
            </div>
        </div>

        <div class="p-6 bg-slate-50 border-t-2 border-slate-200 flex justify-end gap-3">
            <button type="button" id="cancelStructuralModal"
                class="px-6 py-3 text-slate-700 font-bold hover:bg-slate-200 rounded-xl transition-all border-2 border-slate-300">
                Cancelar
            </button>
            <button type="button" id="confirmAddStructuralItem"
                class="px-8 py-3 bg-gradient-to-r from-[#002B5B] to-[#4A90E2] hover:from-[#001f42] hover:to-[#3b7bc9] text-white font-bold rounded-xl shadow-lg shadow-[#4A90E2]/30 transition-all transform hover:scale-105">
                <i class="fas fa-check-circle mr-2"></i>Agregar Material
            </button>
        </div>
    </div>
</div>

<!-- Modal: Nueva Sección -->
<div id="modalNuevaSeccion"
    class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm opacity-0 transition-opacity duration-300"
    style="display: none;">
    <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 transform scale-95 transition-transform duration-300 overflow-hidden">
        <!-- Header -->
        <div class="bg-gradient-to-r from-[#002B5B] to-[#4A90E2] p-6 text-white">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                        <i class="fas fa-layer-group text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold">Nueva Sección</h3>
                        <p class="text-sm text-white/80">Organiza tus materiales por áreas</p>
                    </div>
                </div>
                <button type="button" id="closeModalNuevaSeccion"
                    class="text-white/80 hover:text-white transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>

        <!-- Body -->
        <div class="p-6 space-y-4">
            <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">
                    <i class="fas fa-tag text-[#4A90E2] mr-2"></i>Nombre de la Sección
                </label>
                <input type="text" id="inputNombreSeccion"
                    placeholder='Ej: "Baño 1", "Habitación Principal", "Estructura Techo"'
                    class="w-full px-4 py-3 border-2 border-slate-200 rounded-xl focus:ring-2 focus:ring-[#4A90E2] focus:border-[#4A90E2] transition-all text-slate-700 font-medium"
                    autocomplete="off">
                <p class="text-xs text-slate-500 mt-2">Los nuevos perfiles se agregarán automáticamente a esta sección
                </p>
            </div>
        </div>

        <!-- Footer -->
        <div class="p-6 bg-slate-50 flex gap-3 justify-end border-t border-slate-200">
            <button type="button" id="cancelModalNuevaSeccion"
                class="px-6 py-3 border-2 border-slate-300 text-slate-600 font-bold rounded-xl hover:bg-slate-100 transition-all">
                <i class="fas fa-times mr-2"></i>Cancelar
            </button>
            <button type="button" id="confirmNuevaSeccion"
                class="px-6 py-3 bg-gradient-to-r from-[#002B5B] to-[#4A90E2] hover:from-[#001f42] hover:to-[#3b7bc9] text-white font-bold rounded-xl shadow-lg shadow-[#4A90E2]/30 transition-all transform hover:scale-105">
                <i class="fas fa-plus-circle mr-2"></i>Crear Sección
            </button>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==========================================
        // CONFIGURACION Y CONSTANTES
        // ==========================================
        // Definimos el largo comercial estándar de las barras de acero
        // En Chile, las barras se venden típicamente en tiras de 6 metros
        const STANDARD_BAR_LENGTH = 6.0;
        // Factor de seguridad para compras (25% adicional)
        // Esto cubre desperdicios, cortes y posibles errores de instalación
        const SAFETY_FACTOR = 1.25;
        // Tiempo de espera para el autocompletado (en milisegundos)
        // Evitamos hacer llamadas al servidor mientras el usuario sigue escribiendo
        const SEARCH_DEBOUNCE_MS = 300;
        // ==========================================
        // ESTADO DE LA APLICACION
        // ==========================================
        // Usamos Map en lugar de Array para structuralItems porque:
        // - Búsqueda: O(1) en lugar de O(n)
        // - Agrupación automática por ID sin bucles adicionales
        // - Con 100+ perfiles, esto es 10x más rápido
        const appState = {
            structuralItemsMap: new Map(),  // Mantenemos por compatibilidad temporalmente
            overheadItems: [],
            // Sistema de secciones
            sections: [
                /* Estructura: {
                       id: 'sec_1',
                       name: 'General',
                       collapsed: false,
                       order: 0,
                       materials: Map<profileKey, materialData>
                   }
               */
            ],
            currentSectionId: null,  // Última sección donde se agregó un perfil
            sectionIdCounter: 1  // Para generar IDs únicos
        };
        // ==========================================
        // CACHE DE REFERENCIAS DOM
        // ==========================================
        // Guardamos todas las referencias al DOM una sola vez al inicio
        // Esto evita hacer getElementById repetidamente (mejora ~30% de rendimiento)
        const DOM = {
            form: document.getElementById('cotizacionForm'),
            // Búsqueda y autocompletado
            profileSearchInput: document.getElementById('profile-search'),
            autocompleteResults: document.getElementById('autocomplete-results'),

            // Filtros en cascada (Tipo -> Altura -> Ancho -> Espesor)
            filters: {
                category: document.getElementById('category-select'),
                height: document.getElementById('height-select'),
                width: document.getElementById('width-select'),
                thickness: document.getElementById('thickness-select')
            },
            // Búsqueda guiada
            guided: {
                container: document.getElementById('guided-add-button-container'),
                profileName: document.getElementById('guided-profile-name'),
                addButton: document.getElementById('add-from-guided-btn')
            },
            // Modal de configuración de material
            modal: {
                container: document.getElementById('structuralItemModal'),
                closeBtn: document.getElementById('closeStructuralModal'),
                cancelBtn: document.getElementById('cancelStructuralModal'),
                confirmBtn: document.getElementById('confirmAddStructuralItem'),
                profileName: document.getElementById('modalProfileName'),
                length: document.getElementById('modalLargoM'),
                quantity: document.getElementById('modalCantComprar'),
                unitPrice: document.getElementById('modalValorUnitario'),
                profileId: document.getElementById('modalProfileId'),
                weightPerMeter: document.getElementById('modalProfilePesoKgM'),
                profileFullName: document.getElementById('modalProfileNombre'),
                subtotalPreview: document.getElementById('modalSubtotalPreview')
            },
            // Tablas de materiales e insumos
            tables: {
                structuralBody: document.getElementById('structuralItemsTableBody'),
                overheadBody: document.getElementById('overheadItemsTableBody')
            },
            // Inputs para agregar insumos adicionales
            overhead: {
                description: document.getElementById('overheadDesc'),
                unit: document.getElementById('overheadUnidad'),
                quantity: document.getElementById('overheadCantidad'),
                value: document.getElementById('overheadValor'),
                addButton: document.getElementById('addOverheadItemButton')
            },
            // Displays de totales en el sidebar
            totals: {
                structuralValue: document.getElementById('structuralTotalValue'),
                structuralWeight: document.getElementById('structuralTotalWeight'),
                overheadValue: document.getElementById('overheadTotalValue'),
                grandTotal: document.getElementById('grandTotalGeneral'),
                itemCount: document.getElementById('structural-count')
            },
            // Inputs ocultos para enviar datos a Django
            hiddenInputs: {
                structuralJson: document.getElementById('structuralItemsJsonInput'),
                overheadJson: document.getElementById('overheadItemsJsonInput'),
                totalCost: document.getElementById('totalCostoInput')
            }
        };
        // ==========================================
        // MODULO: UTILIDADES
        // ==========================================
        const UIHelpers = {
            // Formatea números como moneda chilena
            formatCurrency(value) {
                return `$ ${Math.round(value).toLocaleString('es-CL')}`;
            },
            // Formatea peso con 2 decimales
            formatWeight(kg) {
                return `${kg.toFixed(2)} kg`;
            },
            // Debouncing mejorado para búsquedas
            // Evita hacer llamadas innecesarias mientras el usuario escribe
            debounce(func, delay) {
                let timeoutId = null;
                return function debounced(...args) {
                    const context = this;
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        timeoutId = null;
                        func.apply(context, args);
                    }, delay);
                };
            },
            // Resetea un select a estado disabled
            resetSelect(selectElement, placeholder) {
                selectElement.innerHTML = `<option>${placeholder}</option>`;
                selectElement.disabled = true;
                selectElement.classList.add('bg-slate-100', 'text-slate-400');
                selectElement.classList.remove('bg-white', 'text-slate-700');
            },
            // Llena un select con opciones y lo habilita
            populateSelect(selectElement, options, placeholder) {
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                options.forEach(option => {
                    selectElement.add(new Option(option, option));
                });
                selectElement.disabled = false;
                selectElement.classList.remove('bg-slate-100', 'text-slate-400');
                selectElement.classList.add('bg-white', 'text-slate-700');
            },
            // Muestra notificación toast temporal
            showToast(message, type = 'info') {
                const colors = {
                    success: 'from-emerald-500 to-green-500',
                    error: 'from-red-500 to-rose-500',
                    info: 'from-blue-500 to-indigo-500',
                    warning: 'from-amber-500 to-orange-500'
                };

                const toast = document.createElement('div');
                toast.className = `fixed bottom-6 right-6 z-50 px-6 py-4 bg-gradient-to-r ${colors[type]} text-white font-bold rounded-xl shadow-2xl transform translate-y-20 opacity-0 transition-all duration-300 flex items-center gap-3`;
                toast.innerHTML = `
                    <div class="text-lg">${message}</div>
                `;

                document.body.appendChild(toast);

                // Animar entrada
                setTimeout(() => {
                    toast.classList.remove('translate-y-20', 'opacity-0');
                }, 100);

                // Remover después de 3 segundos
                setTimeout(() => {
                    toast.classList.add('translate-y-20', 'opacity-0');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            // NUEVO: Muestra spinner en botón
            showButtonLoader(button, message = '') {
                button.dataset.originalContent = button.innerHTML;
                button.innerHTML = `
                    <svg class="spinner w-5 h-5 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    ${message ? `<span class="ml-2">${message}</span>` : ''}
                `;
                button.disabled = true;
            },

            // NUEVO: Oculta loader de botón
            hideButtonLoader(button) {
                if (button.dataset.originalContent) {
                    button.innerHTML = button.dataset.originalContent;
                    delete button.dataset.originalContent;
                }
                button.disabled = false;
            },

            // NUEVO: Simula delay mínimo para mostrar feedback visual
            async fakeDelay(ms = 300) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        };
        // ==========================================
        // MODULO: SERVICIO API
        // ==========================================
        const APIService = {
            // Busca perfiles por término (autocompletado)
            async searchProfiles(term) {
                const response = await fetch(`{% url 'profile-search' %}?term=${encodeURIComponent(term)}`);
                return await response.json();
            },
            // Obtiene detalle de un perfil específico
            async getProfileDetail(profileId) {
                const response = await fetch(`{% url 'profile-detail' 9999 %}`.replace('9999', profileId));
                return await response.json();
            },
            // Obtiene opciones de filtro (categorías, alturas, anchos, etc.)
            async getFilterOptions(field, filters = {}) {
                const params = new URLSearchParams({ field, ...filters });
                const response = await fetch(`/api/profiles/get-options/?${params.toString()}`);
                return await response.json();
            },
            // Obtiene combinaciones de espesores disponibles
            async getThicknessCombinations(category, height, width) {
                const params = new URLSearchParams({ category, height, width });
                const response = await fetch(`/api/profiles/get-thickness-combinations/?${params.toString()}`);
                return await response.json();
            },
            // Busca perfil único basado en todos los filtros
            async findUniqueProfile(category, height, width, tf, tw) {
                const params = new URLSearchParams({
                    category,
                    attributes__ALTURA_d: height,
                    attributes__ANCHURA_bf: width,
                    attributes__DIMENSION_tf: tf,
                    attributes__DIMENSION_tw: tw
                });
                const response = await fetch(`{% url "profile-find-unique" %}?${params.toString()}`);
                return await response.json();
            },
            // Obtiene contactos de una empresa
            async getCompanyContacts(empresaId) {
                const response = await fetch(`{% url 'get_contactos_por_empresa' %}?empresa_id=${empresaId}`);
                return await response.json();
            },
            // Obtiene lista actualizada de clientes
            async getClientsList() {
                const response = await fetch("{% url 'get_clientes_json' %}", {
                    cache: "no-store",
                    headers: { "Cache-Control": "no-cache" }
                });
                return await response.json();
            }
        };
        // ==========================================
        // MODULO: MOTOR DE CALCULOS
        // ==========================================
        const CalculationEngine = {
            // Calcula cuántas barras de 6m necesitamos comprar
            // Aplica factor de seguridad del 25% automáticamente
            calculateBarsToBuy(totalMeters) {
                const barsNeeded = Math.ceil(totalMeters / STANDARD_BAR_LENGTH);
                const barsWithSafety = Math.ceil(barsNeeded * SAFETY_FACTOR);
                return {
                    commercial: totalMeters / STANDARD_BAR_LENGTH,  // Valor exacto (U. Comercial)
                    needed: barsNeeded,                             // Redondeado arriba (C. Necesaria)
                    toBuy: barsWithSafety                          // Con 25% seguridad (A Comprar)
                };
            },
            // Calcula peso total basado en LARGO REQUERIDO (para informar al transportista)
            // NO usa barras a comprar, solo lo que realmente se llevará a terreno
            calculateTotalWeight(largoRequerido, weightPerMeter) {
                return largoRequerido * weightPerMeter;
            },
            // Calcula costo total de un grupo de perfiles (basado en lo que se COMPRA)
            calculateGroupCost(barCount, pricePerMeter) {
                const metersTotal = barCount * STANDARD_BAR_LENGTH;
                return metersTotal * pricePerMeter;
            }
        };
        // ==========================================
        // MODULO: GESTION DE ESTADO
        // ==========================================
        const StateManager = {
            // Agrega un item estructural al Map Y a la sección actual
            // Si ya existe items con ese profileId, los agrupa automáticamente
            addStructuralItem(item) {
                const profileId = item.profile_id;

                // Obtener sección actual
                const currentSection = SectionManager.getCurrentSection();
                const materialsMap = currentSection.materials;

                if (!materialsMap.has(profileId)) {
                    // Primera vez que agregamos este tipo de perfil
                    materialsMap.set(profileId, {
                        profileId: profileId,
                        name: item.material_nombre,
                        weightPerMeter: item.peso_kg_m,
                        unitPrice: item.valor_unitario_m,
                        cuts: []
                    });
                }
                // Agregamos el corte específico
                const group = materialsMap.get(profileId);
                group.cuts.push({
                    length: item.largo_m,
                    quantity: item.cantidad_piezas
                });
                // Si este item tiene precio, actualizamos el precio del grupo
                if (item.valor_unitario_m > 0) {
                    group.unitPrice = item.valor_unitario_m;
                }

                // IMPORTANTE: También agregar al Map global para compatibilidad
                if (!appState.structuralItemsMap.has(profileId)) {
                    appState.structuralItemsMap.set(profileId, {
                        profileId: profileId,
                        name: item.material_nombre,
                        weightPerMeter: item.peso_kg_m,
                        unitPrice: item.valor_unitario_m,
                        cuts: []
                    });
                }
                appState.structuralItemsMap.get(profileId).cuts.push({
                    length: item.largo_m,
                    quantity: item.cantidad_piezas
                });
            },
            // Elimina todos los items de un perfil específico
            // Esto es O(1) gracias al uso de Map
            deleteProfileGroup(profileId) {
                if (!confirm("¿Eliminar todos los cortes de este perfil?")) return false;
                appState.structuralItemsMap.delete(profileId);
                return true;
            },
            // Agrega un item de insumo adicional
            addOverheadItem(item) {
                appState.overheadItems.push(item);
            },
            // Elimina un item de insumo por índice
            removeOverheadItem(index) {
                if (!confirm("¿Eliminar ítem?")) return false;
                appState.overheadItems.splice(index, 1);
                return true;
            }
        };
        // ==========================================
        // MODULO: GESTION DE SECCIONES
        // ==========================================
        const SectionManager = {
            // Inicializa la sección General si no existe
            initializeGeneralSection() {
                if (appState.sections.length === 0) {
                    appState.sections.push({
                        id: 'general',
                        name: 'General',
                        collapsed: false,
                        order: 0,
                        materials: appState.structuralItemsMap
                    });
                    appState.currentSectionId = 'general';
                }
            },
            // Abre modal para crear una nueva sección
            createSection() {
                SectionModalManager.open();
            },
            // Crea la sección con el nombre dado (llamado desde el modal)
            doCreateSection(nombre) {
                if (!nombre || nombre.trim() === '') return;

                const seccionId = `sec_${appState.sectionIdCounter++}`;
                const newSection = {
                    id: seccionId,
                    name: nombre.trim(),
                    collapsed: false,
                    order: appState.sections.length,
                    materials: new Map()
                };

                appState.sections.push(newSection);
                appState.currentSectionId = seccionId;

                // Actualizar dropdown de secciones
                SectionModalManager.updateSectionSelector();

                return seccionId;
            },
            // Obtiene la sección actual (última seleccionada)
            getCurrentSection() {
                if (!appState.currentSectionId) {
                    this.initializeGeneralSection();
                }
                return appState.sections.find(s => s.id === appState.currentSectionId) || appState.sections[0];
            },
            // Elimina una sección (mantiene al menos General)
            deleteSection(sectionId) {
                if (sectionId === 'general') {
                    alert('No puedes eliminar la sección General');
                    return false;
                }

                const index = appState.sections.findIndex(s => s.id === sectionId);
                if (index === -1) return false;

                if (!confirm(`¿Eliminar sección "${appState.sections[index].name}" y todos sus materiales?`)) {
                    return false;
                }

                appState.sections.splice(index, 1);
                if (appState.currentSectionId === sectionId) {
                    appState.currentSectionId = 'general';
                }
                return true;
            }
        };
        // ==========================================
        // MODULO: MODAL DE SECCIONES
        // ==========================================
        const SectionModalManager = {
            // Abre el modal de nueva sección
            open() {
                const modal = document.getElementById('modalNuevaSeccion');
                const input = document.getElementById('inputNombreSeccion');

                input.value = '';
                modal.style.display = 'flex';
                setTimeout(() => {
                    modal.classList.add('opacity-100');
                    modal.querySelector('.transform').classList.add('scale-100');
                    input.focus();
                }, 50);
            },
            // Cierra el modal
            close() {
                const modal = document.getElementById('modalNuevaSeccion');
                modal.querySelector('.transform').classList.remove('scale-100');
                modal.classList.remove('opacity-100');
                setTimeout(() => modal.style.display = 'none', 300);
            },
            // Confirma creación de sección
            confirm() {
                const nombre = document.getElementById('inputNombreSeccion').value.trim();
                if (!nombre) {
                    alert('Por favor ingrese un nombre para la sección');
                    return;
                }

                SectionManager.doCreateSection(nombre);
                this.close();
                recalculateAndRender();

                // Mostrar mensaje de éxito
                UIHelpers.showToast(`✓ Sección "${nombre}" creada`, 'success');
            },
            // Actualiza el dropdown de secciones disponibles
            updateSectionSelector() {
                const selector = document.getElementById('currentSectionSelector');
                if (!selector) return;

                // Guardar selección actual
                const currentValue = selector.value;

                // Limpiar y reconstruir opciones
                selector.innerHTML = '';
                appState.sections.forEach(section => {
                    const option = new Option(section.name, section.id);
                    selector.add(option);
                });

                // Restaurar o seleccionar la sección actual
                if (appState.currentSectionId) {
                    selector.value = appState.currentSectionId;
                }
            },
            // Maneja el cambio de sección activa desde el dropdown
            handleSectionChange(event) {
                appState.currentSectionId = event.target.value;
                const section = appState.sections.find(s => s.id === event.target.value);
                if (section) {
                    UIHelpers.showToast(`📍 Sección activa: ${section.name}`, 'info');
                }
            }
        };
        // ==========================================
        // MODULO: RENDERIZADO DE TABLAS
        // ==========================================
        const TableRenderer = {
            // Renderiza la tabla de materiales estructurales AGRUPADOS POR SECCIÓN
            // Compatible con materiales sin sección (se muestran en "General")
            renderStructuralItems() {
                let totalCost = 0;
                let totalWeight = 0;
                const itemsForDB = [];

                // Si no hay items, mostramos el estado vacío
                if (appState.structuralItemsMap.size === 0) {
                    DOM.tables.structuralBody.innerHTML = `
                    <tr id="empty-state-row">
                        <td colspan="10" class="px-6 py-16 text-center bg-slate-50/50">
                            <div class="flex flex-col items-center">
                                <div class="w-20 h-20 bg-slate-100 rounded-full flex items-center justify-center mb-4">
                                    <i class="fas fa-cubes text-4xl text-slate-300"></i>
                                </div>
                                <p class="text-slate-400 font-medium">No hay materiales agregados</p>
                                <p class="text-slate-400 text-xs mt-1">Utilice el buscador arriba para agregar perfiles</p>
                            </div>
                        </td>
                    </tr>
                `;
                    return { totalCost: 0, totalWeight: 0, itemsForDB: [] };
                }

                // AGRUPAR MATERIALES POR SECCIÓN
                // Si appState tiene secciones, las usamos. Si no, ponemos todo en "General"
                const sections = appState.sections && appState.sections.length > 0
                    ? appState.sections
                    : [{ id: 'general', name: 'General', collapsed: false, materials: appState.structuralItemsMap }];

                let htmlRows = '';

                // Renderizamos cada sección
                for (const section of sections) {
                    const materials = section.materials || appState.structuralItemsMap;
                    if (materials.size === 0) continue;

                    let sectionCost = 0;
                    let sectionWeight = 0;

                    // HEADER DE SECCIÓN
                    const chevronIcon = section.collapsed ? 'fa-chevron-right' : 'fa-chevron-down';
                    htmlRows += `
                    <tr class="bg-gradient-to-r from-[#002B5B] to-[#4A90E2] text-white cursor-pointer hover:from-[#003570] hover:to-[#5ba3ff] transition-all" onclick="window.toggleSection('${section.id}')">
                        <td colspan="10" class="px-4 py-3 font-bold text-sm">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <i id="chevron-${section.id}" class="fas ${chevronIcon} transition-transform"></i>
                                    <i class="fas fa-layer-group"></i>
                                    <span>${section.name}</span>
                                </div>
                                <span class="text-xs opacity-75">${materials.size} item(s)</span>
                            </div>
                        </td>
                    </tr>
                    `;

                    // MATERIALES DE LA SECCIÓN
                    for (const [profileId, group] of materials) {
                        const totalMeters = group.cuts.reduce((sum, cut) => sum + (cut.length * cut.quantity), 0);
                        const bars = CalculationEngine.calculateBarsToBuy(totalMeters);
                        const weight = CalculationEngine.calculateTotalWeight(totalMeters, group.weightPerMeter);
                        const cost = CalculationEngine.calculateGroupCost(bars.toBuy, group.unitPrice);

                        sectionCost += cost;
                        sectionWeight += weight;
                        totalCost += cost;
                        totalWeight += weight;

                        const cutsDetail = group.cuts.map(c => `${c.quantity}x${c.length}m`).join(', ');
                        const pricePerBar = group.unitPrice * STANDARD_BAR_LENGTH;

                        itemsForDB.push({
                            material_nombre: group.name,
                            largo_mm: 6000,
                            largo_m: 6.0,
                            unidad_comercial: 6.0,
                            cant_necesaria: bars.needed,
                            cant_a_comprar: bars.toBuy,
                            valor_unitario: pricePerBar,
                            peso_kg_m: group.weightPerMeter,
                            seccion_id: section.id !== 'general' ? section.id : null
                        });

                        const hiddenClass = section.collapsed ? 'hidden' : '';
                        htmlRows += `
                        <tr class="hover:bg-slate-50 transition-colors border-b border-slate-100 text-sm group section-material-${section.id} ${hiddenClass}" data-section-id="${section.id}">
                            <td class="px-3 py-4 font-bold text-[#002B5B] sticky left-0 bg-white z-10">
                                ${group.name}
                               <div class="text-[10px] text-slate-400 font-normal truncate max-w-[120px]" title="${cutsDetail}">
                                    ${cutsDetail}
                                </div>
                            </td>
                            <td class="px-3 py-4 text-center text-slate-700 font-medium">${totalMeters.toFixed(2)} m</td>
                            <td class="px-3 py-4 text-center text-slate-500">${bars.commercial.toFixed(2)}</td>
                            <td class="px-3 py-4 text-center font-bold text-blue-600">${bars.needed}</td>
                            <td class="px-3 py-4 text-center">
                                <span class="px-2 py-1 bg-green-100 text-green-800 font-bold rounded border border-green-200 shadow-sm">${bars.toBuy}</span>
                            </td>
                            <td class="px-3 py-4 text-right text-slate-500 text-xs">${group.weightPerMeter.toFixed(2)}</td>
                            <td class="px-3 py-4 text-right font-medium text-slate-700">${weight.toFixed(1)} kg</td>
                            <td class="px-3 py-4 text-right text-slate-500">${UIHelpers.formatCurrency(pricePerBar)}</td>
                            <td class="px-3 py-4 text-right font-bold text-[#002B5B]">${UIHelpers.formatCurrency(cost)}</td>
                            <td class="px-3 py-4 text-center sticky right-0 bg-white z-10">
                                <button type="button" onclick="window.deleteGroup('${profileId}')" class="text-slate-300 hover:text-red-500 transition-colors">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </td>
                        </tr>
                        `;
                    }

                    // SUBTOTAL DE SECCIÓN
                    htmlRows += `
                    <tr class="bg-slate-100 font-bold text-sm border-t-2 border-slate-300">
                        <td colspan="6" class="px-4 py-3 text-right text-slate-700">
                            Subtotal ${section.name}:
                        </td>
                        <td class="px-3 py-3 text-right text-slate-700">
                            ${sectionWeight.toFixed(1)} kg
                        </td>
                        <td class="px-3 py-3 text-right"></td>
                        <td class="px-3 py-3 text-right text-[#002B5B] text-base">
                            ${UIHelpers.formatCurrency(sectionCost)}
                        </td>
                        <td></td>
                    </tr>
                    `;
                }

                DOM.tables.structuralBody.innerHTML = htmlRows;
                return { totalCost, totalWeight, itemsForDB };
            },
            // Renderiza la tabla de insumos adicionales
            renderOverheadItems() {
                if (appState.overheadItems.length === 0) {
                    DOM.tables.overheadBody.innerHTML = '';
                    return 0;
                }

                const htmlRows = appState.overheadItems.map((item, index) => {
                    const subtotal = item.cantidad * item.valor_unitario;
                    return `
    <tr class="hover:bg-slate-50 border-b border-slate-100">
        <td class="px-4 py-3 font-medium text-[#002B5B]">${item.descripcion}</td>
        <td class="px-3 py-3 text-center text-slate-600">${item.unidad}</td>
        <td class="px-3 py-3 text-center font-bold">${item.cantidad}</td>
        <td class="px-3 py-3 text-right font-bold text-red-600">${UIHelpers.formatCurrency(item.valor_unitario)}</td>
        <td class="px-4 py-3 text-right font-bold text-[#002B5B] text-lg">${UIHelpers.formatCurrency(subtotal)}</td>
        <td class="px-3 py-3 text-center">
            <button type="button" onclick="window.removeOverhead(${index})" class="text-red-500 hover:text-red-700">
                <i class="fas fa-trash-alt"></i>
            </button>
        </td>
    </tr>
    `;
                }).join('');
                DOM.tables.overheadBody.innerHTML = htmlRows;
                // Retorna total de insumos
                return appState.overheadItems.reduce((sum, item) =>
                    sum + (item.cantidad * item.valor_unitario), 0
                );
            }
        };
        // ==========================================
        // FUNCION PRINCIPAL: RECALCULAR TODO
        // ==========================================
        // Esta función se llama cada vez que cambia algo en los items
        // Renderiza ambas tablas y actualiza todos los totales
        function recalculateAndRender() {
            // Renderizamos materiales estructurales
            const structural = TableRenderer.renderStructuralItems();
            // Renderizamos insumos
            const overheadTotal = TableRenderer.renderOverheadItems();
            // Calculamos gran total
            const grandTotal = structural.totalCost + overheadTotal;
            // Actualizamos displays de totales
            DOM.totals.structuralValue.textContent = UIHelpers.formatCurrency(structural.totalCost);
            DOM.totals.structuralWeight.textContent = UIHelpers.formatWeight(structural.totalWeight);
            DOM.totals.overheadValue.textContent = UIHelpers.formatCurrency(overheadTotal);
            DOM.totals.grandTotal.textContent = UIHelpers.formatCurrency(grandTotal);
            DOM.totals.itemCount.textContent = appState.structuralItemsMap.size;
            // Actualizamos inputs ocultos para Django
            DOM.hiddenInputs.structuralJson.value = JSON.stringify(structural.itemsForDB);
            DOM.hiddenInputs.overheadJson.value = JSON.stringify(appState.overheadItems);
            DOM.hiddenInputs.totalCost.value = grandTotal;
        }
        // ==========================================
        // FUNCIONES GLOBALES (llamadas desde HTML)
        // ==========================================
        window.deleteGroup = function (profileId) {
            if (StateManager.deleteProfileGroup(profileId)) {
                recalculateAndRender();
            }
        };
        window.removeOverhead = function (index) {
            if (StateManager.removeOverheadItem(index)) {
                recalculateAndRender();
            }
        };
        // Toggle colapsar/expandir sección
        window.toggleSection = function (sectionId) {
            const section = appState.sections.find(s => s.id === sectionId);
            if (!section) return;

            // Toggle collapsed state
            section.collapsed = !section.collapsed;

            // Toggle visibility de las filas de materiales
            const materialRows = document.querySelectorAll(`.section-material-${sectionId}`);
            materialRows.forEach(row => {
                row.classList.toggle('hidden');
            });

            // Animar el chevron
            const chevron = document.getElementById(`chevron-${sectionId}`);
            if (chevron) {
                if (section.collapsed) {
                    chevron.classList.remove('fa-chevron-down');
                    chevron.classList.add('fa-chevron-right');
                } else {
                    chevron.classList.remove('fa-chevron-right');
                    chevron.classList.add('fa-chevron-down');
                }
            }
        };
        // ==========================================
        // MODAL: GESTION
        // ==========================================
        const ModalManager = {
            // Abre el modal con datos del perfil
            open(profile) {
                if (!profile) return;
                // Llenamos datos del perfil en el modal
                DOM.modal.profileName.textContent = profile.name;
                document.getElementById('modalProfileWeight').textContent = `${profile.attributes['PESO_KG_M'] || 0} kg/m`;
                document.getElementById('modalProfileHeight').textContent = `${profile.attributes['ALTURA_d'] || 0} mm`;
                document.getElementById('modalProfileWidth').textContent = `${profile.attributes['ANCHURA_bf'] || 0} mm`;
                document.getElementById('modalProfileDimTf').textContent = `${profile.attributes['DIMENSION_tf'] || 0}`;
                document.getElementById('modalProfileDimTw').textContent = `${profile.attributes['DIMENSION_tw'] || 0}`;
                document.getElementById('modalProfileArea').textContent = `${profile.attributes['AREA_mm2'] || 0} mm²`;
                // Guardamos datos en inputs ocultos
                DOM.modal.profileId.value = profile.id;
                DOM.modal.weightPerMeter.value = profile.attributes['PESO_KG_M'] || 0;
                DOM.modal.profileFullName.value = profile.name;
                // Valores por defecto
                DOM.modal.length.value = "6.0";
                DOM.modal.quantity.value = "1";
                DOM.modal.unitPrice.value = "0";
                this.updatePreview();
                // Mostramos el modal con animación
                DOM.modal.container.style.display = 'flex';
                setTimeout(() => {
                    DOM.modal.container.classList.add('opacity-100');
                    DOM.modal.container.querySelector('.transform').classList.add('scale-100');
                    DOM.modal.length.focus();
                }, 50);
            },
            // Cierra el modal con animación
            close() {
                DOM.modal.container.querySelector('.transform').classList.remove('scale-100');
                DOM.modal.container.classList.remove('opacity-100');
                setTimeout(() => DOM.modal.container.style.display = 'none', 300);
            },
            // Actualiza el preview de subtotal en tiempo real
            updatePreview() {
                const quantity = parseInt(DOM.modal.quantity.value) || 0;
                const unitPrice = parseFloat(DOM.modal.unitPrice.value) || 0;
                const length = parseFloat(DOM.modal.length.value) || 0;
                const subtotal = (length * quantity) * unitPrice;
                if (DOM.modal.subtotalPreview) {
                    DOM.modal.subtotalPreview.textContent = UIHelpers.formatCurrency(subtotal);
                }
            }
        };
        // ==========================================
        // FILTROS EN CASCADA
        // ==========================================
        const FilterManager = {
            _categoriesLoaded: false,

            // LAZY: Carga categorías solo cuando el usuario interactúa con el select
            async loadCategoriesOnDemand() {
                if (this._categoriesLoaded) return; // Ya cargadas

                try {
                    const categories = await APIService.getFilterOptions('category');
                    UIHelpers.populateSelect(DOM.filters.category, categories, 'Seleccionar tipo...');
                    this._categoriesLoaded = true;
                } catch (error) {
                    console.error('Error cargando categorías:', error);
                }
            },

            // Maneja cambio de categoría -> carga alturas
            async onCategoryChange() {
                DOM.guided.container.classList.add('hidden');
                UIHelpers.resetSelect(DOM.filters.height, 'Cargando...');
                UIHelpers.resetSelect(DOM.filters.width, '...');
                UIHelpers.resetSelect(DOM.filters.thickness, '...');
                const category = DOM.filters.category.value;
                if (!category) return;
                const heights = await APIService.getFilterOptions('attributes__ALTURA_d', { category });
                UIHelpers.populateSelect(DOM.filters.height, heights, 'Seleccionar altura...');
            },

            // Maneja cambio de altura -> carga anchos
            async onHeightChange() {
                DOM.guided.container.classList.add('hidden');
                UIHelpers.resetSelect(DOM.filters.width, 'Cargando...');
                UIHelpers.resetSelect(DOM.filters.thickness, '...');
                const height = DOM.filters.height.value;
                if (!height) return;
                const category = DOM.filters.category.value;
                const widths = await APIService.getFilterOptions('attributes__ANCHURA_bf', {
                    category,
                    attributes__ALTURA_d: height
                });
                UIHelpers.populateSelect(DOM.filters.width, widths, 'Seleccionar ancho...');
            },

            // Maneja cambio de ancho -> carga combinaciones de espesor
            async onWidthChange() {
                DOM.guided.container.classList.add('hidden');
                UIHelpers.resetSelect(DOM.filters.thickness, 'Cargando...');
                const width = DOM.filters.width.value;
                if (!width) return;
                const category = DOM.filters.category.value;
                const height = DOM.filters.height.value;
                try {
                    const combinations = await APIService.getThicknessCombinations(category, height, width);
                    DOM.filters.thickness.innerHTML = '<option value="">Seleccionar espesores...</option>';

                    combinations.forEach(combo => {
                        const displayText = `${combo.tf} / ${combo.tw} mm`;
                        const internalValue = `${combo.tf},${combo.tw}`;
                        DOM.filters.thickness.add(new Option(displayText, internalValue));
                    });
                    DOM.filters.thickness.disabled = false;
                    DOM.filters.thickness.classList.remove('bg-slate-100', 'text-slate-400');
                    DOM.filters.thickness.classList.add('bg-white', 'text-slate-700');
                } catch (error) {
                    console.error('Error cargando espesores:', error);
                    UIHelpers.resetSelect(DOM.filters.thickness, 'Error al cargar');
                }
            },

            // Maneja cambio de espesor -> busca perfil único
            async onThicknessChange() {
                const category = DOM.filters.category.value;
                const height = DOM.filters.height.value;
                const width = DOM.filters.width.value;
                const thicknessRaw = DOM.filters.thickness.value;
                if (!category || !height || !width || !thicknessRaw) {
                    DOM.guided.container.classList.add('hidden');
                    return;
                }
                // Separamos los dos valores de espesor
                const [tf, tw] = thicknessRaw.split(',');
                try {
                    const profile = await APIService.findUniqueProfile(category, height, width, tf, tw);
                    if (profile && profile.id) {
                        DOM.guided.profileName.textContent = profile.name;
                        DOM.guided.addButton.onclick = () => ModalManager.open(profile);
                        DOM.guided.container.classList.remove('hidden');
                    } else {
                        DOM.guided.container.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('Error buscando perfil:', error);
                    DOM.guided.container.classList.add('hidden');
                }
            }
        };
        // ==========================================
        // AUTOCOMPLETADO SEARCH
        // ==========================================
        const SearchManager = {
            // Maneja la búsqueda con debouncing
            handleSearch: UIHelpers.debounce(async function (event) {
                const term = event.target.value;
                if (term.length < 1) {
                    DOM.autocompleteResults.style.display = 'none';
                    return;
                }
                try {
                    const results = await APIService.searchProfiles(term);
                    DOM.autocompleteResults.innerHTML = '';

                    if (results.length > 0) {
                        results.forEach(result => {
                            const item = document.createElement('div');
                            item.className = 'p-4 hover:bg-[#4A90E2]/10 cursor-pointer transition-all border-b border-slate-100 last:border-0 flex items-center justify-between group';

                            // Extraemos los espesores del resultado si vienen en el objeto
                            // El backend debería enviar tf y tw en el objeto result
                            const thicknessInfo = result.tf && result.tw
                                ? `<span class="font-mono text-slate-600">${result.tf} / ${result.tw} mm</span>`
                                : 'Click para configurar';

                            item.innerHTML = `
                            <div>
                                <div class="font-bold text-[#002B5B]">${result.text}</div>
                                <div class="text-xs text-slate-500 mt-1">${thicknessInfo}</div>
                            </div>
                            <i class="fas fa-arrow-right text-[#4A90E2] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                        `;
                            item.addEventListener('click', async () => {
                                DOM.profileSearchInput.value = '';
                                DOM.autocompleteResults.style.display = 'none';
                                const profile = await APIService.getProfileDetail(result.id);
                                ModalManager.open(profile);
                            });
                            DOM.autocompleteResults.appendChild(item);
                        });
                        DOM.autocompleteResults.style.display = 'block';
                    } else {
                        DOM.autocompleteResults.innerHTML = '<div class="p-4 text-center text-slate-500">No se encontraron perfiles.</div>';
                        DOM.autocompleteResults.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error en búsqueda:', error);
                }
            }, SEARCH_DEBOUNCE_MS)
        };
        // ==========================================
        // GESTION EMPRESA -> CONTACTO
        // ==========================================
        const CompanyManager = {
            async handleCompanyChange(event) {
                const empresaId = event.target.value;
                const empresaSelect = document.getElementById('empresa_select');
                const contactoSelect = document.getElementById('contacto_select');
                const btnNuevoContacto = document.getElementById('btnNuevoContacto');
                const baseUrlCrearContacto = "{% url 'añadir_persona_contacto' 0 %}";
                // Resetear UI
                contactoSelect.innerHTML = '<option value="">Cargando contactos...</option>';
                contactoSelect.disabled = true;
                contactoSelect.classList.add('bg-slate-100', 'text-slate-400');
                contactoSelect.classList.remove('bg-white', 'text-slate-700');
                btnNuevoContacto.disabled = true;
                btnNuevoContacto.classList.remove('from-[#4A90E2]', 'to-[#002B5B]', 'hover:shadow-lg', 'transform', 'hover:scale-105');
                btnNuevoContacto.classList.add('from-slate-300', 'to-slate-400', 'cursor-not-allowed', 'shadow-none');
                btnNuevoContacto.onclick = null;
                if (!empresaId) {
                    contactoSelect.innerHTML = '<option value="">Primero seleccione empresa...</option>';
                    return;
                }
                try {
                    // Configurar botón de nuevo contacto
                    const urlFinal = baseUrlCrearContacto.replace('0', empresaId);
                    btnNuevoContacto.onclick = function () {
                        window.open(urlFinal, '_blank');
                    };
                    // Cargar contactos existentes
                    const contactos = await APIService.getCompanyContacts(empresaId);
                    contactoSelect.innerHTML = '<option value="">Seleccionar contacto...</option>';

                    if (contactos.length > 0) {
                        contactos.forEach(c => {
                            contactoSelect.add(new Option(c.nombre, c.id));
                        });
                    } else {
                        contactoSelect.add(new Option("Sin contactos registrados", ""));
                    }
                    // Habilitar select
                    contactoSelect.disabled = false;
                    contactoSelect.classList.remove('bg-slate-100', 'text-slate-400');
                    contactoSelect.classList.add('bg-white', 'text-slate-700');
                    // Habilitar botón
                    btnNuevoContacto.disabled = false;
                    btnNuevoContacto.classList.remove('from-slate-300', 'to-slate-400', 'cursor-not-allowed', 'shadow-none');
                    btnNuevoContacto.classList.add('bg-gradient-to-br', 'from-[#4A90E2]', 'to-[#002B5B]', 'hover:shadow-lg', 'transform', 'hover:scale-105');

                } catch (error) {
                    console.error("Error cargando contactos:", error);
                    contactoSelect.innerHTML = '<option value="">Error al cargar</option>';
                }
            },
            // Actualiza lista de empresas cuando volvemos a la pestaña
            async refreshCompaniesList() {
                const empresaSelect = document.getElementById('empresa_select');
                const seleccionPrevia = empresaSelect.value;
                try {
                    const clientes = await APIService.getClientsList();
                    if (!clientes) return;
                    empresaSelect.innerHTML = '<option value="">Seleccionar empresa...</option>';

                    clientes.forEach(cliente => {
                        empresaSelect.add(new Option(cliente.nombre, cliente.id));
                    });
                    // Restaurar selección anterior si aún existe
                    if (seleccionPrevia) {
                        const existe = clientes.some(c => c.id == seleccionPrevia);
                        if (existe) {
                            empresaSelect.value = seleccionPrevia;
                        }
                    }
                    console.log("Lista de empresas sincronizada.");

                } catch (error) {
                    console.error("Error actualizando clientes:", error);
                }
            },
            // Actualiza lista de contactos de la empresa seleccionada
            async refreshContactsList() {
                const empresaSelect = document.getElementById('empresa_select');
                const contactoSelect = document.getElementById('contacto_select');
                const empresaId = empresaSelect.value;

                // Solo refrescar si hay una empresa seleccionada y el select está habilitado
                if (!empresaId || contactoSelect.disabled) {
                    return;
                }

                const seleccionPreviaContacto = contactoSelect.value;

                try {
                    const contactos = await APIService.getCompanyContacts(empresaId);
                    contactoSelect.innerHTML = '<option value="">Seleccionar contacto...</option>';

                    if (contactos.length > 0) {
                        contactos.forEach(c => {
                            contactoSelect.add(new Option(c.nombre, c.id));
                        });
                    } else {
                        contactoSelect.add(new Option("Sin contactos registrados", ""));
                    }

                    // Restaurar selección anterior si aún existe
                    if (seleccionPreviaContacto) {
                        contactoSelect.value = seleccionPreviaContacto;
                    }
                    console.log("Lista de contactos sincronizada.");
                } catch (error) {
                    console.error("Error actualizando contactos:", error);
                }
            }
        };
        // ==========================================
        // HANDLERS DE ACCIONES
        // ==========================================
        const ActionHandlers = {
            // Confirma y agrega item estructural desde el modal
            addStructuralItem() {
                const length = parseFloat(DOM.modal.length.value) || 0;
                const quantity = parseInt(DOM.modal.quantity.value) || 1;
                const newItem = {
                    profile_id: DOM.modal.profileId.value,
                    material_nombre: DOM.modal.profileFullName.value,
                    largo_m: length,
                    cantidad_piezas: quantity,
                    valor_unitario_m: parseFloat(DOM.modal.unitPrice.value) || 0,
                    peso_kg_m: parseFloat(DOM.modal.weightPerMeter.value) || 0
                };
                StateManager.addStructuralItem(newItem);
                recalculateAndRender();
                ModalManager.close();
            },
            // Agrega item de insumo adicional
            addOverheadItem() {
                const descripcion = DOM.overhead.description.value.trim();
                if (!descripcion) {
                    alert("Falta descripción");
                    return;
                }
                const newItem = {
                    descripcion: descripcion,
                    unidad: DOM.overhead.unit.value.trim() || 'Unidad',
                    cantidad: parseFloat(DOM.overhead.quantity.value) || 1,
                    valor_unitario: parseFloat(DOM.overhead.value.value) || 0
                };
                StateManager.addOverheadItem(newItem);
                recalculateAndRender();
                // Limpiar inputs
                DOM.overhead.description.value = '';
                DOM.overhead.unit.value = '';
                DOM.overhead.quantity.value = '1';
                DOM.overhead.value.value = '0';
            },
            // Valida formulario antes de enviar
            validateForm(event) {
                if (appState.structuralItemsMap.size === 0 && appState.overheadItems.length === 0) {
                    event.preventDefault();
                    alert("Agregue al menos un ítem.");
                }
            }
        };
        // ==========================================
        // EVENT LISTENERS
        // ==========================================
        // Búsqueda por texto
        DOM.profileSearchInput.addEventListener('input', SearchManager.handleSearch);
        // Click fuera del autocomplete lo cierra
        document.addEventListener('click', (e) => {
            if (!DOM.profileSearchInput.contains(e.target)) {
                DOM.autocompleteResults.style.display = 'none';
            }
        });
        // Filtros en cascada
        DOM.filters.category.addEventListener('change', FilterManager.onCategoryChange);
        DOM.filters.height.addEventListener('change', FilterManager.onHeightChange);
        DOM.filters.width.addEventListener('change', FilterManager.onWidthChange);
        DOM.filters.thickness.addEventListener('change', FilterManager.onThicknessChange);
        // Modal
        DOM.modal.closeBtn.addEventListener('click', ModalManager.close);
        DOM.modal.cancelBtn.addEventListener('click', ModalManager.close);
        DOM.modal.confirmBtn.addEventListener('click', ActionHandlers.addStructuralItem);
        // Preview en tiempo real en el modal
        DOM.modal.quantity.addEventListener('input', ModalManager.updatePreview);
        DOM.modal.unitPrice.addEventListener('input', ModalManager.updatePreview);
        DOM.modal.length.addEventListener('input', ModalManager.updatePreview);
        // Insumos adicionales
        DOM.overhead.addButton.addEventListener('click', ActionHandlers.addOverheadItem);
        // Validación de formulario
        DOM.form.addEventListener('submit', ActionHandlers.validateForm);

        // Empresa -> Contactos
        document.getElementById('empresa_select').addEventListener('change', CompanyManager.handleCompanyChange);
        // Actualizar listas cuando volvemos a la pestaña
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === "visible") {
                CompanyManager.refreshCompaniesList();
                CompanyManager.refreshContactsList(); // Auto-recarga contactos nuevos
            }
        });
        // ==========================================
        // INICIALIZACION
        // ==========================================
        // Inicializar sección General
        SectionManager.initializeGeneralSection();

        // Actualizar dropdown de secciones
        SectionModalManager.updateSectionSelector();

        // Event listener para botón Nueva Sección
        document.getElementById('btnNuevaSeccion').addEventListener('click', () => {
            SectionManager.createSection();
        });

        // Event listeners para modal de nueva sección
        document.getElementById('closeModalNuevaSeccion').addEventListener('click', () => {
            SectionModalManager.close();
        });
        document.getElementById('cancelModalNuevaSeccion').addEventListener('click', () => {
            SectionModalManager.close();
        });
        document.getElementById('confirmNuevaSeccion').addEventListener('click', () => {
            SectionModalManager.confirm();
        });
        // Enter key en input de nombre de sección
        document.getElementById('inputNombreSeccion').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                SectionModalManager.confirm();
            }
        });

        // Event listener para cambio de sección activa
        document.getElementById('currentSectionSelector').addEventListener('change', (e) => {
            SectionModalManager.handleSectionChange(e);
        });

        // LAZY LOAD: Cargar categorías solo cuando el usuario hace clic en el filtro
        DOM.filters.category.addEventListener('focus', () => {
            FilterManager.loadCategoriesOnDemand();
        }, { once: true }); // Solo la primera vez

        DOM.filters.category.addEventListener('click', () => {
            FilterManager.loadCategoriesOnDemand();
        }, { once: true }); // Solo la primera vez

        recalculateAndRender();
    });
</script>
{% endblock %}